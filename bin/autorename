#!/bin/zsh

# è‰²è¨­å®š
RED="\e[31m"
LIGHTRED="\e[1;31m"
GREEN="\e[32m"
YELLOW="\e[33m"
BLUE="\e[34m"
BOLD="\e[1m"
RESET="\e[m"
BG_GRAY="\e[48;5;236m"
BG_BLUE="\e[44m"

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
PREFIX="img"
EXTENSIONS=()  # è¤‡æ•°ã®æ‹¡å¼µå­ã‚’æ ¼ç´ã™ã‚‹é…åˆ—
WATCH_DIR=""
COUNTER_DIGITS=2   # ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®æ¡æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯2æ¡ï¼‰
START_COUNT=1      # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é–‹å§‹ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
END_COUNT=-1       # çµ‚äº†ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ç„¡åˆ¶é™ï¼‰
SHOW_HELP=0        # -h/--help ãŒæŒ‡å®šã•ã‚ŒãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
while [[ $# -gt 0 ]]; do
    case "$1" in
        -p|--prefix)
            PREFIX="$2"
            shift 2
            ;;
        -t|--type)
            EXTENSIONS+=("$2")  # é…åˆ—ã«æ‹¡å¼µå­ã‚’è¿½åŠ 
            shift 2
            ;;
        -c|--counter)
            if [[ "$2" =~ ^[1-9][0-9]*$ ]]; then  # æ•°å€¤ãƒã‚§ãƒƒã‚¯ï¼ˆ1ä»¥ä¸Šã®æ•´æ•°ï¼‰
                COUNTER_DIGITS="$2"
            else
                echo "Invalid counter digits: $2. Using default ($COUNTER_DIGITS)."
            fi
            shift 2
            ;;
        -s|--start)
            if [[ "$2" =~ ^[1-9][0-9]*$ ]]; then
                START_COUNT="$2"
            else
                echo "Invalid start counter: $2. Using default ($START_COUNT)."
            fi
            shift 2
            ;;
        -e|--end)
            if [[ "$2" =~ ^[1-9][0-9]*$ ]]; then
                END_COUNT="$2"
            else
                echo "Invalid end counter: $2. Ignoring."
            fi
            shift 2
            ;;
        -h|--help)
            SHOW_HELP=1
            shift
            ;;
        *)
            if [[ -z "$WATCH_DIR" ]]; then
                WATCH_DIR="$1"
                shift
            else
                echo "Unknown argument: $1"
                exit 1
            fi
            ;;
    esac
done

# `-h` / `--help` ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã¯è©³ç´°ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
if [[ "$SHOW_HELP" -eq 1 ]]; then
    echo -e "${BLUE}${BOLD}Usage:${RESET}"
    echo -e "  autorename <directory_to_watch> ${YELLOW}[-p prefix] [-t extension] [-c digits] [-s start] [-e end]${RESET}\n"

    echo -e "${BLUE}${BOLD}Options:${RESET}"
    echo -e "${BG_BLUE} -p ${RESET} ${YELLOW}(--prefix)${RESET}   Specify the prefix for renamed files. Default: 'img'"
    echo -e "${BG_BLUE} -t ${RESET} ${YELLOW}(--type)${RESET}     Target file extension(s) for auto renaming."
    echo -e "                 To specify multiple types, use: ${BG_GRAY}${LIGHTRED}[-t png -t jpg]${RESET}"
    echo -e "${BG_BLUE} -c ${RESET} ${YELLOW}(--counter)${RESET}   Set the number of digits for numbering. Default: 2"
    echo -e "${BG_BLUE} -s ${RESET} ${YELLOW}(--start)${RESET}     Set the starting counter value. Default: 1"
    echo -e "${BG_BLUE} -e ${RESET} ${YELLOW}(--end)${RESET}       Stop the script when the counter reaches this value."

    echo -e "\n${YELLOW}If -e is not specified, use ${BOLD}Ctrl + C${RESET}${YELLOW} to stop the script manually.${RESET}"
    echo -e "\n${LIGHTRED}Command made by Lyna YUZUHA${RESET}"
    exit 0
fi

# å¿…é ˆå¼•æ•°ã®ç¢ºèªï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆï¼‰
if [[ -z "$WATCH_DIR" ]]; then
    echo -e "${RED}${BOLD}Error: No directory specified.${RESET}\n"
    echo -e "${BLUE}${BOLD}Usage:${RESET}"
    echo -e "  autorename <directory_to_watch> ${YELLOW}[-p prefix] [-t extension] [-c digits] [-s start] [-e end]${RESET}\n"
    echo -e "  ${YELLOW}For more details, use:${RESET} ${BLUE}${BOLD}-h${RESET} ${YELLOW}or${RESET} ${BLUE}${BOLD}--help${RESET}\n"
    exit 1
fi

# `-e` ã®å€¤ãŒ `-s` ã‚ˆã‚Šå°ã•ã„å ´åˆã€è­¦å‘Šã‚’å‡ºã—ã¦ `-e` ã‚’ç„¡è¦–
if [[ "$END_COUNT" -ne -1 && "$END_COUNT" -lt "$START_COUNT" ]]; then
    echo "Warning: End counter ($END_COUNT) is smaller than start counter ($START_COUNT).\nIgnoring end counter."
    END_COUNT=-1
fi

# å¿…é ˆå¼•æ•°ã®ç¢ºèª
if [[ -z "$WATCH_DIR" ]]; then
    echo "Error: No directory specified."
    exit 1
fi

# æ‹¡å¼µå­ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ "png" ã«ã™ã‚‹
if [[ ${#EXTENSIONS[@]} -eq 0 ]]; then
    EXTENSIONS=("png")
fi

echo "Watching directory: $WATCH_DIR for new files of types: ${EXTENSIONS[@]}"
echo "Using prefix: $PREFIX"
echo "Counter digits: $COUNTER_DIGITS"
echo "Start counter: $START_COUNT"
if [[ "$END_COUNT" -ne -1 ]]; then
    echo "End counter: $END_COUNT (Script will stop automatically at this count)"
else
    echo "No end counter specified. Use Ctrl + C to stop manually."
fi

# é€£ç•ªã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®åˆæœŸå€¤
COUNTER="$START_COUNT"

# `fswatch` ã®ãƒ•ã‚£ãƒ«ã‚¿ç”¨ã«æ‹¡å¼µå­ã‚’æ­£è¦è¡¨ç¾ã§çµåˆ
EXT_REGEX=""
for ext in "${EXTENSIONS[@]}"; do
    EXT_REGEX+="-i \\.$ext$ "
done

fswatch -0 $EXT_REGEX "$WATCH_DIR" | while IFS= read -r -d "" file; do
    BASENAME=$(basename "$file")
    DIRNAME=$(dirname "$file")
    EXT="${BASENAME##*.}"  # æ‹¡å¼µå­ã‚’å–å¾—

    # ğŸ”¹ **æ‹¡å¼µå­ãŒæŒ‡å®šã•ã‚ŒãŸ `EXTENSIONS` ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯**
    found_ext=0
    for ext in "${EXTENSIONS[@]}"; do
        if [[ "$EXT" == "$ext" ]]; then
            found_ext=1
            break
        fi
    done

    if [[ "$found_ext" -eq 0 ]]; then
        continue
    fi

    # æ—¢ã«ãƒªãƒãƒ¼ãƒ ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ— (prefix-pXX.æ‹¡å¼µå­ ã®å½¢å¼)
    if [[ "$BASENAME" =~ ^${PREFIX}-p[0-9]+\.${EXT}$ ]]; then
        continue
    fi

    # ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ç¢ºèª
    if [[ ! -e "$file" ]]; then
        continue
    fi

    # é€£ç•ªã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (01, 02, ..., 99, 100, ...) ã®æ¡æ•°ã‚’å‹•çš„ã«å¤‰æ›´
    while [[ -e "$DIRNAME/${PREFIX}-p$(printf "%0${COUNTER_DIGITS}d" $COUNTER).$EXT" ]]; do
        ((COUNTER++))
    done
    NEW_NAME="${PREFIX}-p$(printf "%0${COUNTER_DIGITS}d" $COUNTER).$EXT"
    NEW_PATH="$DIRNAME/$NEW_NAME"

    # ãƒªãƒãƒ¼ãƒ å®Ÿè¡Œ
    if mv "$file" "$NEW_PATH"; then
        echo "Renamed: $file â†’ $NEW_NAME"
        ((COUNTER++))  # å®Ÿéš›ã«æˆåŠŸã—ãŸå ´åˆã®ã¿ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å¢—ã‚„ã™
    else
        echo "Failed to rename: $file"
    fi

    # `-e` ã®å€¤ã«é”ã—ãŸã‚‰çµ‚äº†
    if [[ "$END_COUNT" -ne -1 && "$COUNTER" -gt "$END_COUNT" ]]; then
        echo "End counter ($END_COUNT) reached. Exiting..."
        exit 0
    fi
done
